name: Afdian Sync (reuseable)

on:
  workflow_call:
    secrets:
      AFDIAN_USERID:
        required: true
      AFDIAN_TOKEN:
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Checkout template file
        uses: actions/checkout@v6
        with:
          repository: LuoChu-NB2Dev/.github
          ref: master # 注意修改为你的分支, 例如: master
          path: template-repo

      - name: Afdian action
        uses: yiyungent/afdian-action@main
        with:
          # 在 Settings->Secrets 配置 AFDIAN_USERID, AFDIAN_TOKEN
          # 爱发电 user_id
          afdian_userId: ${{ secrets.AFDIAN_USERID }}
          # 爱发电 token
          afdian_token: ${{ secrets.AFDIAN_TOKEN }}
          # 默认为: .github/afdian-action.cshtml
          template_filePath: "./template-repo/.github/afdian-action.cshtml"
          # 默认为: README.md
          target_filePath: "README.md"
          # 可省, 高级选项: RazorEngine Complie, 在 cshtml 中需要 using 的 namespace, 多个用 ; 隔开
          usings: "System"
          # 可省, 高级选项: RazorEngine Complie, 在 cshtml 中需要添加的 系统引用, 多个用 ; 隔开
          # 例如: assemblyReferences: "System.Collections, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"
          assemblyReferences: "System.Runtime, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"

      - name: Clean Template Repo
        run: rm -rf template-repo

      # 下方为 直接 push 到目标分支, 当然你也可以选择 Pull Request 方式
      - name: Commit changes (cancel run if no changes)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "bot@luochu.cc"
          git config --local user.name "luochu-bot"
          # stage all changes
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit — cancelling run."
            # cancel the current run via REST API
            curl -s -X POST -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/cancel
            exit 0
          else
            git commit -m "⬆️ auto update sponsor" -m "Changelog update was created by afdian-sync workflow"
            git push origin HEAD:${{ github.event.repository.default_branch }}
          fi
